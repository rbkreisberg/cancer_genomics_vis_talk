/**
*
*
* @class  An interactive cubbyhole plot.  A cubbyhole is a graph of nominal/ordinal data vs.  nominal/ordinal data.
*       The data is wiggled such that the distribution for any given value on the continuous scale is more apparent.
*        The circular shape is generated such that there is initially separation for small distributions, with larger distributions
 *        packed into the cubbyhole.
*
*
*
* The JSON Object passed into the {@link CubbyHole#draw} function as input to the visualization:
*
*
* <pre> {
*         data_array : {Array},
*	  xcolumnid : {string},
*	  ycolumnid : {string},
*	  valuecolumnid : {string},
*	  xcolumnvalue : {string},
*	  ycolumnvalue : {string},
*	  valuecolumnvalue : {string},
*	  tooltip_items : {Function},
*	  fill_style : {Function} or {string},
*	  stroke_style : {Function} or {string},
*	  radius : {Number},
*	  radial_interval : {Number},
*	  fill_style : {Function} or {string},
*	  stroke_style : {Function} or {string},
*     	  show_points : {Boolean},
*         notifier : {Function},
* 	  PLOT : {
*			width : {Number},
*			height : {Number},
*			container : {string}  or {HTMLElement}
*          		vertical_padding : {Number},
*          		horizontal_padding : {Number},
*			}
*	}
*	</pre>
*
*  @extends vq.Vis
*/vq.CubbyHole=function(){vq.Vis.call(this),this.height(300),this.width(700),this.vertical_padding(20),this.horizontal_padding(30),this.selectedProbesetId("")},vq.CubbyHole.prototype=vq.extend(vq.Vis),vq.CubbyHole.prototype.property("selectedProbesetId"),vq.CubbyHole.prototype._setOptionDefaults=function(a){a.selectedProbesetId&&(this._selectedProbesetId=a.selectedProbesetId),a.height!=null&&this.height(a.height),a.width!=null&&this.width(a.width),a.container!=null&&this.container(a.container),a.vertical_padding!=null&&this.vertical_padding(a.vertical_padding),a.horizontal_padding!=null&&this.horizontal_padding(a.horizontal_padding)},vq.CubbyHole.prototype.onProbesetSelect=function(a){this.selectedProbesetId=a},vq.CubbyHole.prototype.draw=function(a){var b=this;this.data=new vq.models.CubbyHoleData(a),this._setOptionDefaults(this.data);var c=this.container();if(this.data.isDataReady()){var d=this.data,e=d.COLUMNID.x,f=d.COLUMNID.y,g=d.COLUMNID.value,h=d.data,i=d3.Scale.ordinal(d.sortOrderX).splitBanded(0,b.width(),.8),j=d3.Scale.ordinal(d.sortOrderY).splitBanded(0,b.height(),.8),k=i.range().band/2,l=j.range().band/2,m=l/4,n=k/4,o;this._selectedProbesetId&&(o=this._selectedProbesetId);var p=new Function,q=d3.select(c).append("svg").attr("width",b.width()).attr("height",b.height()).style("padding-bottom",b.vertical_padding()).style("padding-top",b.vertical_padding()).style("padding-left",horizontal_padding()).style("padding-right",horizontal_padding()).append("g").call(p);q.add(pv.Rule).data(j.domain()).bottom(function(a){return j(a)+l}).strokeStyle(function(a){return a?"#ccc":"#999"}).anchor("left").add(pv.Label),q.add(pv.Label).text(d.COLUMNLABEL.y).font(b.font).textAlign("center").left(-20).bottom(this.height()/2).textAngle(-1*Math.PI/2),q.add(pv.Rule).data(i.domain()).left(function(a){return i(a)+k}).strokeStyle(function(a){return a?"#ccc":"#999"}).anchor("bottom").add(pv.Label),q.add(pv.Label).text(d.COLUMNLABEL.x).font(b.font).textAlign("center").bottom(-30).left(this.width()/2),q.add(pv.Rule).data(j.domain()).bottom(function(a){return j(a)-m}).strokeStyle("#444"),q.add(pv.Rule).data(i.domain()).left(function(a){return i(a)-n}).strokeStyle("#444");var r=q.add(pv.Panel).events("all").overflow("hidden"),s=function(a){return d._strokeStyle(a)},t=function(a){return d._fillStyle(a)},u=r.add(pv.Panel).strokeStyle(null).fillStyle(null),v=Math.LN2,w=function(a){return a==0?0:a<=4?1:Math.floor(Math.log(a-1)/v)},x=function(a){return a==0?1:a<=4?4:Math.pow(2,w(a)+1)-Math.pow(2,w(a))},y=function(a){return a/x(a)*2*Math.PI+Math.PI/4*(w(a)%2)},z=d._radial_interval,A=function(a){return w(a)*z},B=function(a){return A(a)*Math.cos(y(a))},C=function(a){return A(a)*Math.sin(y(a))};if(d._showPoints)var D=u.add(pv.Dot).data(h).def("active",-1).left(function(a){return i(a[e])+k+B(a.dist_index)}).bottom(function(a){return j(a[f])+l+C(a.dist_index)}).shape(d._shape).fillStyle(t).strokeStyle(s).radius(d._radius).event("point",function(){this.active(this.index);return E.render()}).event("unpoint",function(){this.active(-1);return E.render()}).event("click",d._notifier),E=D.anchor("right").add(pv.Label).visible(function(){return this.anchorTarget().active()==this.index}).text(function(a){return d.COLUMNLABEL.value+" "+a[g]});q.render()}},vq.models.CubbyHoleData=function(a){vq.models.VisData.call(this,a),this.setDataModel(),this.getDataType()=="vq.models.CubbyHoleData"?this._build_data(this.getContents()):console.warn("Unrecognized JSON object.  Expected vq.models.CubbyHoleData object.")},vq.models.CubbyHoleData.prototype=pv.extend(vq.models.VisData),vq.models.CubbyHoleData.prototype.setDataModel=function(){this._dataModel=[{label:"width",id:"PLOT.width",cast:Number,defaultValue:400},{label:"height",id:"PLOT.height",cast:Number,defaultValue:300},{label:"container",id:"PLOT.container",optional:!0},{label:"vertical_padding",id:"PLOT.vertical_padding",cast:Number,defaultValue:20},{label:"horizontal_padding",id:"PLOT.horizontal_padding",cast:Number,defaultValue:30},{label:"data",id:"data_array",defaultValue:[]},{label:"COLUMNID.x",id:"xcolumnid",cast:String,defaultValue:"X"},{label:"COLUMNID.y",id:"ycolumnid",cast:String,defaultValue:"Y"},{label:"COLUMNID.value",id:"valuecolumnid",cast:String,defaultValue:"VALUE"},{label:"COLUMNLABEL.x",id:"xcolumnlabel",cast:String,defaultValue:""},{label:"COLUMNLABEL.y",id:"ycolumnlabel",cast:String,defaultValue:""},{label:"COLUMNLABEL.value",id:"valuecolumnlabel",cast:String,defaultValue:""},{label:"tooltipItems",id:"tooltip_items",defaultValue:{X:"X",Y:"Y",Value:"VALUE"}},{label:"_fillStyle",id:"fill_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return pv.color("steelblue").alpha(.2)}},{label:"_strokeStyle",id:"stroke_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"steelblue"}},{label:"_radius",id:"radius",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return 2}},{label:"_shape",id:"shape",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"dot"}},{label:"_radial_interval",id:"radial_interval",cast:Number,defaultValue:6},{label:"_showPoints",id:"show_points",cast:Boolean,defaultValue:!0},{label:"_notifier",id:"notifier",cast:Function,defaultValue:function(){return null}}]},vq.models.CubbyHoleData.prototype._build_data=function(a){var b=this;this._processData(a),this.COLUMNLABEL.x==""&&(this.COLUMNLABEL.x=this.COLUMNID.x),this.COLUMNLABEL.y==""&&(this.COLUMNLABEL.y=this.COLUMNID.y),this.COLUMNLABEL.value==""&&(this.COLUMNLABEL.value=this.COLUMNID.value);var c=this.COLUMNID.x,d=this.COLUMNID.y,e=this.COLUMNID.value;this.dist={},this.dist_index={},this.data.forEach(function(a){b.dist[a[c]]===undefined&&(b.dist[a[c]]={}),b.dist[a[c]][a[d]]===undefined&&(b.dist[a[c]][a[d]]=0),a.dist_index=b.dist[a[c]][a[d]],b.dist[a[c]][a[d]]++}),this.sortOrderX=pv.uniq(b.data,function(a){return a[c]}).sort(),this.sortOrderY=pv.uniq(b.data,function(a){return a[d]}).sort(),this.data.length>0&&this.setDataReady(!0)}